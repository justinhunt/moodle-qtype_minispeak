define(["jquery","core/log","qtype_minispeak/definitions","qtype_minispeak/pollyhelper"],(function($,log,def,polly){return log.debug("minispeak dictation: initialising"),{answers:{},playing:!1,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper,polly){this.prepare_audio(itemdata,polly),this.register_events(index,itemdata,quizhelper)},prepare_html:function(itemdata){},prepare_audio:function(itemdata){$.each(itemdata.sentences,(function(index,sentence){polly.fetch_polly_url(sentence.prompt,itemdata.voiceoption,itemdata.usevoice).then((function(audiourl){$("#"+itemdata.uniqueid+"_container .dictationplayer_"+index+" .dictationtrigger").attr("data-src",audiourl)}))}))},register_events:function(qindex,itemdata,quizhelper){var self=this,theplayer=$("#"+itemdata.uniqueid+"_player"),lastgrade=null,totalanswer=$("#"+itemdata.uniqueid+"_container .dictate-feedback").length;function updateGrade(){var stepdata={},correctanswer=$("#"+itemdata.uniqueid+"_container .dictate-feedback.fa-check").length,grade=Math.round(100*correctanswer/totalanswer,2);grade!==lastgrade&&(lastgrade=grade,stepdata.index=qindex,stepdata.hasgrade=!0,stepdata.grade=grade,stepdata.totalitems=totalanswer,stepdata.correctitems=correctanswer,stepdata.answers=self.answers,quizhelper.do_next(stepdata))}$("#"+itemdata.uniqueid+"_container .poodlldictationinput input").on("input",(function(e){var index=$(this).data("index"),correct=itemdata.sentences[index].sentence.trim().toLowerCase(),typed=$(this).val().trim().toLowerCase();$("#"+itemdata.uniqueid+"_container .dictationplayer_"+index+"_chars").html(typed.length),itemdata.ignorepunctuation&&(correct=quizhelper.cleanText(correct),typed=quizhelper.cleanText(typed)),self.answers[index]={answer:typed,correct:correct==typed},correct==typed?$("#"+itemdata.uniqueid+"_container .dictate-feedback[data-index='"+index+"']").removeClass("fa-times").addClass("fa-check").css("color","green").show():$("#"+itemdata.uniqueid+"_container .dictate-feedback[data-index='"+index+"']").removeClass("fa-check").addClass("fa-times").css("color","red").show(),updateGrade()})),$("#"+itemdata.uniqueid+"_container .dictationtrigger").on("click",(function(e){if(!self.playing){var el=this;self.playing=!0,theplayer.attr("src",$(this).attr("data-src")),theplayer[0].play(),theplayer[0].onended=function(){$(el).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-play"),self.playing=!1},$(el).find(".fa").removeClass("fa-play").addClass("fa-spin fa-spinner")}})),$("#"+itemdata.uniqueid+"_container .minispeak_nextbutton").on("click",updateGrade)}}}));

//# sourceMappingURL=dictation.min.js.map