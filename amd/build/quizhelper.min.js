define(["jquery","core/log","qtype_minispeak/definitions","core/templates","core/ajax","qtype_minispeak/dictation","qtype_minispeak/dictationchat","qtype_minispeak/multichoice","qtype_minispeak/multiaudio","qtype_minispeak/speechcards","qtype_minispeak/listenrepeat","qtype_minispeak/page","qtype_minispeak/smartframe","qtype_minispeak/shortanswer","qtype_minispeak/listeninggapfill","qtype_minispeak/typinggapfill","qtype_minispeak/speakinggapfill"],(function($,log,def,templates,Ajax,dictation,dictationchat,multichoice,multiaudio,speechcards,listenrepeat,page,smartframe,shortanswer,listeninggapfill,typinggapfill,speakinggapfill){return log.debug("minispeak Quiz helper: initialising"),{spliton_regexp:new RegExp(/([!"# ¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),nopunc_regexp:new RegExp(/[!"#¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~]/,"g"),nonspaces_regexp:new RegExp(/[^ ]/,"g"),autoplaydelay:800,controls:{},submitbuttonclass:"qtype_minispeak_quizsubmitbutton",stepresults:[],payloadJson:{},init:function(quizcontainer,activitydata,cmid,attemptid,polly){this.quizdata=activitydata.quizdata,this.region=activitydata.region,this.ttslanguage=activitydata.ttslanguage,this.controls.quizcontainer=quizcontainer,this.attemptid=attemptid,this.courseurl=activitydata.courseurl,this.cmid=cmid,this.reattempturl=activitydata.reattempturl,this.activityurl=activitydata.activityurl,this.backtocourse=activitydata.backtocourse,this.stt_guided=activitydata.stt_guided,this.wwwroot=activitydata.wwwroot,this.useanimatecss=activitydata.useanimatecss,this.questioninstances=[],this.controls.payloadfield=$("#"+this.quizdata[0].payloadfield),this.controls.payloadfield.attr("data-qubaid",this.quizdata[0].qubaid),this.controls.sequencecheck=$('input[name="'+this.controls.payloadfield.attr("name").replace("payload",":sequencecheck")+'"]'),this.controls.status={hassubitems:this.quizdata[0].hassubitems,card:$("#".concat(this.quizdata[0].uniqueid,"_statuscard")),find:function(name,selector){let parent=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return parent&&this.hasOwnProperty(parent)?this[name]=this[parent].find(selector):this[name]=this.card.find(selector),this},op:function(identifiers,callback){var dd=this;return(identifiers=identifiers.split(",")).forEach((function(identifier){dd.hasOwnProperty(identifier)&&callback(dd[identifier])})),dd},show:function(identifiers){return this.op(identifiers,(function(instance){instance.attr("data-display","show")}))},hide:function(identifiers){return this.op(identifiers,(function(instance){instance.attr("data-display","hide")}))},hideAll:function(){return this.hide("card,nonattempt,result,summary")},text:function(identifier,text){return this.hasOwnProperty(identifier)&&this[identifier].text(text),this},get:function(identifier){if(this.hasOwnProperty(identifier))return this[identifier]}},this.controls.status.find("result",".qtype_minispeak_statustext"),this.controls.status.find("summary",'[data-region="summary"]',"result"),this.controls.status.find("completed",'[data-region="completedcount"]',"summary"),this.controls.status.find("total",'[data-region="totalcount"]',"summary"),this.controls.status.find("nonattempt",".qtype_minispeak_statustext_nonattempt"),this.controls.status.find("retrybutton",".qtype_minispeak_retrybutton"),this.prepare_html(),this.init_questions(this.quizdata,polly),this.register_events(),this.start_quiz()},prepare_html:function(){this.controls.quizfinished=$("#qtype_minispeak_quiz_finished"),this.updateSummaryCard()},updateSummaryCard:function(){var payload=this.controls.payloadfield.val();if(payload&&""!==payload.trim()){var payloadArr=payload.split(".");try{var payloadEncData=atob(payloadArr[1]);payloadEncData=payloadEncData.replace(/"/g,"").replace(/'/g,""),payloadEncData=atob(payloadEncData),this.payloadJson=JSON.parse(payloadEncData),log.debug(this.payloadJson),this.payloadJson.hasgrade?(this.controls.status.show("card,result"),this.controls.status.hassubitems&&this.controls.status.text("completed",this.payloadJson.correctitems).text("total",this.payloadJson.totalitems).show("summary")):this.quizdata[0].locked?this.controls.status.show("card,nonattempt"):this.controls.status.hideAll()}catch(e){log.debug(e)}}else this.quizdata[0].locked?this.controls.status.show("card,nonattempt"):this.controls.status.hideAll()},init_questions:function(quizdata,polly){var dd=this;$.each(quizdata,(function(index,item){var questioninstance;switch(item.type){case def.qtype_dictation:questioninstance=dictation.clone();break;case def.qtype_dictationchat:questioninstance=dictationchat.clone();break;case def.qtype_multichoice:questioninstance=multichoice.clone();break;case def.qtype_multiaudio:questioninstance=multiaudio.clone();break;case def.qtype_speechcards:questioninstance=speechcards.clone();break;case def.qtype_listenrepeat:questioninstance=listenrepeat.clone();break;case def.qtype_page:questioninstance=page.clone();break;case def.qtype_smartframe:questioninstance=smartframe.clone();break;case def.qtype_shortanswer:questioninstance=shortanswer.clone();break;case def.qtype_listeninggapfill:questioninstance=listeninggapfill.clone();break;case def.qtype_typinggapfill:questioninstance=typinggapfill.clone();break;case def.qtype_speakinggapfill:questioninstance=speakinggapfill.clone()}questioninstance&&(questioninstance.init(index,item,dd,polly),dd.questioninstances.push(questioninstance))})),$("audio.qtype_minispeak_itemttsaudio").each((function(){var that=this;polly.fetch_polly_url($(this).data("text"),$(this).data("ttsoption"),$(this).data("voice")).then((function(audiourl){$(that).attr("src",audiourl)}))}))},register_events:function(){var dd=this;$("."+this.submitbuttonclass).on("click",(function(){}));var retrybutton=this.controls.status.get("retrybutton");retrybutton&&retrybutton.on("click",(function(e){e.preventDefault(),dd.report_step_grade({},!1,!0).then((function(token){var reloadcallback=function(){location.reload()};if(token)try{require(["core_form/changechecker"],(function(changechecker){changechecker.resetFormDirtyState(retrybutton.get(0)),reloadcallback()}))}catch(e){log.debug("old moodle found"),void 0!==M.core_formchangechecker&&M.core_formchangechecker.reset_form_dirty_state(),reloadcallback()}}))}))},render_quiz_progress:function(current,total){for(var array=[],i=0;i<total;i++)array.push(i);if(total<6){var html="<div class='minispeak_quiz_progress_line' style='"+(linestyles="width: "+(100-100/(slice=array.slice(0,5)).length)+"%; margin-left: auto; margin-right: auto")+"'></div>";slice.forEach((function(i){html+="<div class='minispeak_quiz_progress_item "+(i===current?"minispeak_quiz_progress_item_current":"")+" "+(i<current?"minispeak_quiz_progress_item_completed":"")+"'>"+(i+1)+"</div>"}))}else{if(current>total-6)var slice=array.slice(total-5,total-1);else slice=array.slice(current,current+4);if(0==current)var linestyles="width: 80%; margin-left: auto; margin-right: auto";else linestyles="width: "+(100-100/(2*slice.length))+"%; margin-left: 0";html="<div class='minispeak_quiz_progress_line' style='"+linestyles+"'></div>";slice.forEach((function(i){html+="<div class='minispeak_quiz_progress_item "+(i===current?"minispeak_quiz_progress_item_current":"")+" "+(i<current?"minispeak_quiz_progress_item_completed":"")+"'>"+(i+1)+"</div>"})),html+="<div class='minispeak_quiz_progress_finalitem'>"+total+"</div>"}html+="",$(".minispeak_quiz_progress").html(html)},do_next:function(stepdata,showSummary){var dd=this,currentquizdataindex=stepdata.index,currentitem=this.quizdata[currentquizdataindex];if(!0!==currentitem.preview&&(dd.report_step_grade(stepdata,showSummary),!0!==currentitem.singlemode)){var theoldquestion=$("#"+currentitem.uniqueid+"_container");if(theoldquestion.hide(),!(dd.quizdata.length>currentquizdataindex+1))return $(".minispeak_nextbutton").prop("disabled",!0),void setTimeout((function(){window.location.href=dd.activityurl}),1e3);var nextindex=currentquizdataindex+1,nextitem=this.quizdata[nextindex];switch($("#"+nextitem.uniqueid+"_container").show(),nextitem.type){case def.qtype_speechcards:case def.qtype_dictation:case def.qtype_dictationchat:case def.qtype_multichoice:case def.qtype_multiaudio:case def.qtype_listenrepeat:case def.qtype_smartframe:case def.qtype_shortanswer:}var ttsquestionplayer=$("#"+nextitem.uniqueid+"_container audio.qtype_minispeak_itemttsaudio");if("1"==ttsquestionplayer.data("autoplay")){setTimeout((function(){ttsquestionplayer[0].play()}),this.autoplaydelay)}this.render_quiz_progress(stepdata.index+1,this.quizdata.length),theoldquestion.remove()}},report_step_grade:function(stepdata,showSummary){let store=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var dd=this;this.stepresults.push(stepdata),log.debug(stepdata);var ret=Ajax.call([{methodname:"qtype_minispeak_report_step_grade",args:{cmid:dd.cmid,qubaid:dd.quizdata[0].qubaid,step:btoa(JSON.stringify(stepdata)),store:Boolean(store)},async:!1}])[0].then((function(response){if(response.newsequence&&dd.controls.sequencecheck.val(response.newsequence),response.token)return dd.controls.payloadfield.val(response.token),showSummary&&dd.updateSummaryCard(),response.token}));return log.debug("report_step_grade success: "+ret),ret},start_quiz:function(){$("#"+this.quizdata[0].uniqueid+"_container").show();var ttsquestionplayer=$("#"+this.quizdata[0].uniqueid+"_container audio.qtype_minispeak_itemttsaudio");if("1"==ttsquestionplayer.data("autoplay")){setTimeout((function(){ttsquestionplayer[0].play()}),this.autoplaydelay)}this.render_quiz_progress(0,this.quizdata.length)},onSubmit:function(){alert("quiz submitted. Override this")},mobile_user:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},chrome_user:function(){return!!/Chrome/i.test(navigator.userAgent)},use_ttrecorder:function(){return!0},is_stt_guided:function(){return this.stt_guided},similarity:function(s1,s2){var longer=s1=s1.replace(/\s+/g,""),shorter=s2=s2.replace(/\s+/g,"");s1.length<s2.length&&(longer=s2,shorter=s1);var longerLength=longer.length;return 0===longerLength?100:(longerLength-this.editDistance(longer,shorter))/parseFloat(longerLength)*100},editDistance:function(s1,s2){s1=s1.toLowerCase(),s2=s2.toLowerCase();for(var costs=[],i=0;i<=s1.length;i++){for(var lastValue=i,j=0;j<=s2.length;j++)if(0===i)costs[j]=j;else if(j>0){var newValue=costs[j-1];s1.charAt(i-1)!==s2.charAt(j-1)&&(newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1),costs[j-1]=lastValue,lastValue=newValue}i>0&&(costs[s2.length]=lastValue)}return costs[s2.length]},cleanText:function(text){return text.toLowerCase().replace(this.nopunc_regexp,"").replace(/\s+/g," ").trim()},checkByPhonetic:function(passage,transcript,passagephonetic,language){return Ajax.call([{methodname:"qtype_minispeak_check_by_phonetic",args:{spoken:transcript,correct:passage,language:language,phonetic:passagephonetic,region:this.region,cmid:this.cmid},async:!1}])[0]},comparePassageToTranscript:function(passage,transcript,passagephonetic,language){return Ajax.call([{methodname:"qtype_minispeak_compare_passage_to_transcript",args:{passage:passage,transcript:transcript,alternatives:"",phonetic:passagephonetic,language:language,region:this.region,cmid:this.cmid},async:!1}])[0]}}}));

//# sourceMappingURL=quizhelper.min.js.map