define ("qtype_minispeak/quizhelper",["jquery","core/log","qtype_minispeak/definitions","core/templates","core/ajax","qtype_minispeak/dictation","qtype_minispeak/dictationchat","qtype_minispeak/multichoice","qtype_minispeak/multiaudio","qtype_minispeak/speechcards","qtype_minispeak/listenrepeat","qtype_minispeak/page","qtype_minispeak/smartframe","qtype_minispeak/shortanswer","qtype_minispeak/listeninggapfill","qtype_minispeak/typinggapfill","qtype_minispeak/speakinggapfill"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";b.debug("minispeak Quiz helper: initialising");return{spliton_regexp:new RegExp(/([!"# ¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),nopunc_regexp:new RegExp(/[!"#¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~]/,"g"),nonspaces_regexp:new RegExp(/[^ ]/,"g"),autoplaydelay:800,controls:{},submitbuttonclass:"qtype_minispeak_quizsubmitbutton",stepresults:[],payloadJson:{},init:function init(b,c,d,e,f){this.quizdata=c.quizdata;this.region=c.region;this.ttslanguage=c.ttslanguage;this.controls.quizcontainer=b;this.attemptid=e;this.courseurl=c.courseurl;this.cmid=d;this.reattempturl=c.reattempturl;this.activityurl=c.activityurl;this.backtocourse=c.backtocourse;this.stt_guided=c.stt_guided;this.wwwroot=c.wwwroot;this.useanimatecss=c.useanimatecss;this.questioninstances=[];this.controls.payloadfield=a("#"+this.quizdata[0].payloadfield);this.controls.payloadfield.attr("data-qubaid",this.quizdata[0].qubaid);this.controls.sequencecheck=a("input[name=\""+this.controls.payloadfield.attr("name").replace("payload",":sequencecheck")+"\"]");this.controls.status={hassubitems:this.quizdata[0].hassubitems,card:a("#".concat(this.quizdata[0].uniqueid,"_statuscard")),find:function find(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(c&&this.hasOwnProperty(c)){this[a]=this[c].find(b)}else{this[a]=this.card.find(b)}return this},op:function op(a,b){var c=this,a=a.split(",");a.forEach(function(a){if(c.hasOwnProperty(a)){b(c[a])}});return c},show:function show(a){return this.op(a,function(a){a.attr("data-display","show")})},hide:function hide(a){return this.op(a,function(a){a.attr("data-display","hide")})},hideAll:function hideAll(){return this.hide("card,nonattempt,result,summary")},text:function text(a,b){if(this.hasOwnProperty(a)){this[a].text(b)}return this},get:function get(a){if(this.hasOwnProperty(a)){return this[a]}}};this.controls.status.find("result",".qtype_minispeak_statustext");this.controls.status.find("summary","[data-region=\"summary\"]","result");this.controls.status.find("completed","[data-region=\"completedcount\"]","summary");this.controls.status.find("total","[data-region=\"totalcount\"]","summary");this.controls.status.find("nonattempt",".qtype_minispeak_statustext_nonattempt");this.controls.status.find("retrybutton",".qtype_minispeak_retrybutton");this.prepare_html();this.init_questions(this.quizdata,f);this.register_events();this.start_quiz()},prepare_html:function prepare_html(){this.controls.quizfinished=a("#qtype_minispeak_quiz_finished");this.updateSummaryCard()},updateSummaryCard:function updateSummaryCard(){var a=this.controls.payloadfield.val();if(a&&""!==a.trim()){var c=a.split(".");try{var d=atob(c[1]);d=d.replace(/"/g,"").replace(/'/g,"");d=atob(d);this.payloadJson=JSON.parse(d);if(this.payloadJson.hasgrade){this.controls.status.show("card,result");if(this.controls.status.hassubitems){this.controls.status.text("completed",this.payloadJson.correctitems).text("total",this.payloadJson.totalitems).show("summary")}}else if(this.quizdata[0].locked){this.controls.status.show("card,nonattempt")}else{this.controls.status.hideAll()}}catch(a){b.debug(a)}}else if(this.quizdata[0].locked){this.controls.status.show("card,nonattempt")}else{this.controls.status.hideAll()}},init_questions:function init_questions(b,d){var e=this;a.each(b,function(a,b){var r;switch(b.type){case c.qtype_dictation:r=f.clone();break;case c.qtype_dictationchat:r=g.clone();break;case c.qtype_multichoice:r=h.clone();break;case c.qtype_multiaudio:r=i.clone();break;case c.qtype_speechcards:r=j.clone();break;case c.qtype_listenrepeat:r=k.clone();break;case c.qtype_page:r=l.clone();break;case c.qtype_smartframe:r=m.clone();break;case c.qtype_shortanswer:r=n.clone();break;case c.qtype_listeninggapfill:r=o.clone();break;case c.qtype_typinggapfill:r=p.clone();break;case c.qtype_speakinggapfill:r=q.clone();break;}if(r){r.init(a,b,e,d);e.questioninstances.push(r)}});a("audio.qtype_minispeak_itemttsaudio").each(function(){var b=this;d.fetch_polly_url(a(this).data("text"),a(this).data("ttsoption"),a(this).data("voice")).then(function(c){a(b).attr("src",c)})})},register_events:function register_events(){var c=this;a("."+this.submitbuttonclass).on("click",function(){});var d=this.controls.status.get("retrybutton");if(d){d.on("click",function(a){a.preventDefault();c.report_step_grade({},!1,!0).then(function(a){var c=function(){location.reload()};if(a){try{require(["core_form/changechecker"],function(a){a.resetFormDirtyState(d.get(0));c()})}catch(a){b.debug("old moodle found");if(M.core_formchangechecker!==void 0){M.core_formchangechecker.reset_form_dirty_state()}c()}}})})}},render_quiz_progress:function render_quiz_progress(b,c){for(var d=[],e=0;e<c;e++){d.push(e)}if(6>c){var f=d.slice(0,5),g="width: "+(100-100/f.length)+"%; margin-left: auto; margin-right: auto",h="<div class='minispeak_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minispeak_quiz_progress_item "+(a===b?"minispeak_quiz_progress_item_current":"")+" "+(a<b?"minispeak_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"})}else{if(b>c-6){var f=d.slice(c-5,c-1)}else{var f=d.slice(b,b+4)}if(0==b){var g="width: 80%; margin-left: auto; margin-right: auto"}else{var g="width: "+(100-100/(2*f.length))+"%; margin-left: 0"}var h="<div class='minispeak_quiz_progress_line' style='"+g+"'></div>";f.forEach(function(a){h+="<div class='minispeak_quiz_progress_item "+(a===b?"minispeak_quiz_progress_item_current":"")+" "+(a<b?"minispeak_quiz_progress_item_completed":"")+"'>"+(a+1)+"</div>"});h+="<div class='minispeak_quiz_progress_finalitem'>"+c+"</div>"}h+="";a(".minispeak_quiz_progress").html(h)},do_next:function do_next(b,d){var e=this,f=b.index,g=this.quizdata[f];if(!0===g.preview){return}e.report_step_grade(b,d);if(!0===g.singlemode){return}var h=a("#"+g.uniqueid+"_container");h.hide();if(e.quizdata.length>f+1){var i=this.quizdata[f+1];a("#"+i.uniqueid+"_container").show();switch(i.type){case c.qtype_speechcards:break;case c.qtype_dictation:case c.qtype_dictationchat:case c.qtype_multichoice:case c.qtype_multiaudio:case c.qtype_listenrepeat:case c.qtype_smartframe:case c.qtype_shortanswer:default:}var j=a("#"+i.uniqueid+"_container audio.qtype_minispeak_itemttsaudio");if("1"==j.data("autoplay")){var k=this;setTimeout(function(){j[0].play()},k.autoplaydelay)}}else{a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){window.location.href=e.activityurl},1e3);return}this.render_quiz_progress(b.index+1,this.quizdata.length);h.remove()},report_step_grade:function report_step_grade(a,c){var d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,f=this;this.stepresults.push(a);var g=e.call([{methodname:"qtype_minispeak_report_step_grade",args:{cmid:f.cmid,qubaid:f.quizdata[0].qubaid,step:btoa(JSON.stringify(a)),store:!!d},async:!1}])[0].then(function(a){if(a.newsequence){f.controls.sequencecheck.val(a.newsequence)}if(a.token){f.controls.payloadfield.val(a.token);if(c){f.updateSummaryCard()}return a.token}});b.debug("report_step_grade success: "+g);return g},start_quiz:function start_quiz(){a("#"+this.quizdata[0].uniqueid+"_container").show();var b=a("#"+this.quizdata[0].uniqueid+"_container audio.qtype_minispeak_itemttsaudio");if("1"==b.data("autoplay")){var c=this;setTimeout(function(){b[0].play()},c.autoplaydelay)}this.render_quiz_progress(0,this.quizdata.length)},onSubmit:function onSubmit(){alert("quiz submitted. Override this")},mobile_user:function mobile_user(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return!0}else{return!1}},chrome_user:function chrome_user(){if(/Chrome/i.test(navigator.userAgent)){return!0}else{return!1}},use_ttrecorder:function use_ttrecorder(){return!0},is_stt_guided:function is_stt_guided(){return this.stt_guided},similarity:function similarity(a,b){a=a.replace(/\s+/g,"");b=b.replace(/\s+/g,"");var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0===e){return 100}return 100*((e-this.editDistance(c,d))/parseFloat(e))},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0===d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!==b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){var b=a.toLowerCase(),c=b.replace(this.nopunc_regexp,""),d=c.replace(/\s+/g," ").trim();return d},checkByPhonetic:function checkByPhonetic(a,b,c,d){return e.call([{methodname:"qtype_minispeak_check_by_phonetic",args:{spoken:b,correct:a,language:d,phonetic:c,region:this.region,cmid:this.cmid},async:!1}])[0]},comparePassageToTranscript:function comparePassageToTranscript(a,b,c,d){return e.call([{methodname:"qtype_minispeak_compare_passage_to_transcript",args:{passage:a,transcript:b,alternatives:"",phonetic:c,language:d,region:this.region,cmid:this.cmid},async:!1}])[0]}}});
//# sourceMappingURL=quizhelper.min.js.map
