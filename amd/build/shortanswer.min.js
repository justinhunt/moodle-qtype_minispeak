function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("qtype_minispeak/shortanswer",["jquery","core/log","qtype_minispeak/definitions","qtype_minispeak/pollyhelper","qtype_minispeak/cloudpoodllloader","qtype_minispeak/ttrecorder","qtype_minispeak/animatecss"],function(a,b,c,d,e,f,g){"use strict";b.debug("minispeak ShortAnswer: initialising");return{answers:{},passmark:90,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d={useanimatecss:c.useanimatecss};g.init(d);this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=1;c.correctitems=0<a?1:0;c.grade=a;c.answers=b.answers;b.quizhelper.do_next(c,!0)},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},register_events:function register_events(b,c,d){var e=this;e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minispeak_nextbutton").on("click",function(){e.next_question(0)});a("#"+c.uniqueid+"_container ."+c.uniqueid+"_option").on("click",function(){a("."+c.uniqueid+"_option").prop("disabled",!0);a("."+c.uniqueid+"_fb").html("<i style='color:red;' class='fa fa-times'></i>");a("."+c.uniqueid+"_option"+c.correctanswer+"_fb").html("<i style='color:green;' class='fa fa-check'></i>");var b=a("input[name="+c.uniqueid+"_options]:checked").data("index"),d=b==c.correctanswer?100:0;a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);e.next_question(d)},2e3)})},init_components:function init_components(c,d,e){var h=this,j=d.sentences;b.debug("initcomponents_shortanswer");b.debug(j);for(var k=0;k<j.length;k++){j[k].originalsentence=j[k].sentence;j[k].sentence=e.cleanText(j[k].sentence)}var l=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function c(f){var k,l,m,n,o,p,q,r,s,t,u,v,w;return regeneratorRuntime.wrap(function(c){while(1){switch(c.prev=c.next){case 0:c.t0=f.type;c.next="recording"===c.t0?3:"speech"===c.t0?4:74;break;case 3:return c.abrupt("break",74);case 4:b.debug("speech at shortanswer");k=f.capturedspeech;l=e.cleanText(k);m=l;b.debug("speechtext:",k);b.debug("cleanspeechtext:",m);n=!1;o=0;p=0;case 13:if(!(p<j.length)){c.next=25;break}if(!(""===j[p].sentence)){c.next=16;break}return c.abrupt("continue",22);case 16:q=e.similarity(m,j[p].sentence);b.debug("JS similarity: "+m+":"+j[p].sentence+":"+q);if(!(q>=h.passmark||h.spokenIsCorrect(e,l,j[p].sentence))){c.next=22;break}o=h.process_accepted_response(d,p);n=!0;return c.abrupt("break",25);case 22:p++;c.next=13;break;case 25:if(n){c.next=42;break}p=0;case 27:if(!(p<j.length)){c.next=42;break}c.next=30;return e.checkByPhonetic(j[p].sentence,m,j[p].phonetic,d.language);case 30:r=c.sent;b.debug(r,"PHP similarity");if(!(!r||r<h.passmark)){c.next=35;break}c.next=39;break;case 35:n=!0;b.debug("PHP similarity: "+m+r);o=h.process_accepted_response(d,p);return c.abrupt("break",42);case 39:p++;c.next=27;break;case 42:if(n){c.next=65;break}p=0;case 44:if(!(p<j.length)){c.next=65;break}c.next=47;return e.comparePassageToTranscript(j[p].sentence,m,j[p].phonetic,d.language);case 47:s=c.sent;t=JSON.parse(s);u=!1;v=0;case 51:if(!(v<t.length)){c.next=58;break}if(!(!1===t[v].matched)){c.next=55;break}u=!0;return c.abrupt("break",58);case 55:v++;c.next=51;break;case 58:if(u){c.next=62;break}o=h.process_accepted_response(d,p);n=!0;return c.abrupt("break",65);case 62:p++;c.next=44;break;case 65:h.answers[0]={answer:m,correct:!!n};if(!n){c.next=72;break}a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);h.next_question(o)},2e3);return c.abrupt("return");case 72:w=a("#"+d.uniqueid+"_correctanswer");g.do_animate(w,"rubberBand animate__faster").then(function(){});case 74:case"end":return c.stop();}}},c)}));return function(){return c.apply(this,arguments)}}(),m={};m.uniqueid=d.uniqueid;b.debug("sa uniqueid:"+d.uniqueid);m.callback=l;m.stt_guided=e.is_stt_guided();f.clone().init(m)},spokenIsCorrect:function spokenIsCorrect(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b===c){return!0}return!1},process_accepted_response:function process_accepted_response(b,c){var d=0<=c?100:0;if(0<d){if(0===parseInt(b.show_text)){for(var e=0;e<b.sentences.length;e++){a("#"+b.uniqueid+"_option"+(e+1));a("#"+b.uniqueid+"_option"+(e+1)+" .minispeak_sentence").text(b.sentences[e].sentence)}}var f=a("#"+b.uniqueid+"_correctanswer");f.text(b.sentences[c].originalsentence);f.addClass("minispeak_success")}return d}}});
//# sourceMappingURL=shortanswer.min.js.map
