define ("qtype_minispeak/multiaudio",["jquery","core/log","qtype_minispeak/definitions","qtype_minispeak/pollyhelper","qtype_minispeak/cloudpoodllloader","qtype_minispeak/ttrecorder","qtype_minispeak/animatecss"],function(a,b,c,d,e,f,g){"use strict";b.debug("minispeak Multiaudio: initialising");return{answers:{},passmark:90,playing:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d={useanimatecss:c.useanimatecss};g.init(d);this.prepare_audio(b);this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=1;c.correctitems=0<a?1:0;c.grade=a;c.answers=b.answers;b.quizhelper.do_next(c,!0)},register_events:function register_events(b,c,d){var e=this,f=a("#"+c.uniqueid+"_player");e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minispeak_nextbutton").on("click",function(){e.next_question(0)});a("#"+c.uniqueid+"_container .mcplayrow").on("click",function(){if(a("#"+c.uniqueid+"_container .mcplayrow").hasClass("minispeak_mc_disabled")){return}if(!e.playing){var b=this;e.playing=!0;f.attr("src",a(this).attr("data-src"));f[0].play();f[0].onended=function(){a(b).find(".minispeak_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1};a(b).find(".minispeak_mc_playstate").removeClass("fa-play").addClass("fa-spin fa-spinner")}else{f[0].pause();f[0].currentTime=0;a("#"+c.uniqueid+"_container .minispeak_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1}})},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},process_accepted_response:function process_accepted_response(b,c){a("#"+b.uniqueid+"_container .mcplayrow").addClass("minispeak_mc_disabled");if(0==parseInt(b.show_text)){for(var d=0;d<b.sentences.length;d++){a("#"+b.uniqueid+"_option"+(d+1));a("#"+b.uniqueid+"_option"+(d+1)+" .minispeak_sentence").text(b.sentences[d].sentence)}}a("#"+b.uniqueid+"_container .minispeak_mc_wrong").show();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minispeak_mc_wrong").hide();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minispeak_mc_right").show();a("#"+b.uniqueid+"_option"+c+" .minispeak_mc_response").addClass("minispeak_mc_selected");var e=c==b.correctanswer?100:0;this.answers[0]={answer:c,correct:c==b.correctanswer};return e},init_components:function init_components(c,d,h){var j=this,k=d.sentences[d.correctanswer-1].sentence,l=d.sentences[d.correctanswer-1].phonetic,m=[];b.debug("initcomponents_multiaudio");b.debug(d.sentences);for(var n=0;n<d.sentences.length;n++){if(n+1==d.correctanswer){m[n]=""}else{m[n]=h.cleanText(d.sentences[n].sentence)}}var o=h.cleanText(k),p=function(c){switch(c.type){case"recording":break;case"speech":b.debug("speech at multiaudio");var e=c.capturedspeech,f=h.cleanText(e),i=f;b.debug("speechtext:",e);b.debug("spoken:",i);b.debug("correct:",o);var k=h.similarity(i,o);b.debug("JS similarity: "+i+":"+o+":"+k);if(k>=j.passmark||j.wordsDoMatch(h,f,o)){b.debug("local correct match::"+i+":"+o);var n=j.process_accepted_response(d,d.correctanswer);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);j.next_question(n)},2e3);return}else{for(var p=0;p<m.length;p++){if(""===m[p]){continue}var q=h.similarity(i,m[p]);b.debug("JS similarity: "+i+":"+m[p]+":"+q);if(q>=j.passmark||j.wordsDoMatch(h,f,m[p])){var n=j.process_accepted_response(d,p+1);a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);j.next_question(n)},2e3);return}}}h.checkByPhonetic(o,i,l,d.language).then(function(c){if(!1===c){return a.Deferred().reject()}else{b.debug("PHP similarity: "+i+":"+o+":"+c);if(c>=j.passmark){var e=j.process_accepted_response(d,d.correctanswer);a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);j.next_question(e)},2e3)}}var f=a("#ttrec_container_"+d.uniqueid);g.do_animate(f,"shakeX animate__faster").then(function(){})});}};if(h.use_ttrecorder()){var q={uniqueid:d.uniqueid};b.debug("ma uniqueid:"+d.uniqueid);q.callback=p;q.stt_guided=h.is_stt_guided();f.clone().init(q)}else{e.init("minispeak-recorder-multiaudio-"+d.id,p)}},wordsDoMatch:function wordsDoMatch(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b==c){return!0}return!1}}});
//# sourceMappingURL=multiaudio.min.js.map
