define ("qtype_minispeak/speakinggapfill",["jquery","core/log","core/ajax","qtype_minispeak/definitions","qtype_minispeak/pollyhelper","qtype_minispeak/cloudpoodllloader","qtype_minispeak/ttrecorder","qtype_minispeak/animatecss","qtype_minispeak/progresstimer"],function(a,b,c,d,e,f,g,h){"use strict";b.debug("minispeak speaking gap fill: initialising");return{answers:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){var e=this,i=function(a){switch(a.type){case"recording":break;case"speech":b.debug("Speech at speaking gap fill -");var c=e.items[e.game.pointer].words,d=[];Object.keys(c).forEach(function(a){d.push(c[a])});e.getComparison(d.join(" "),a.capturedspeech,e.items[e.game.pointer].phonetic,function(b){e.gotComparison(b,a)});break;}};if(d.use_ttrecorder()){var j={uniqueid:c.uniqueid,callback:i,stt_guided:d.is_stt_guided(),wwwroot:d.is_stt_guided()};g.clone().init(j)}else{f.init("minispeak-recorder-listenrepeat-"+c.id,i)}e.itemdata=c;b.debug("itemdata");b.debug(c);e.quizhelper=d;e.index=a;var k={useanimatecss:d.useanimatecss};h.init(k);e.register_events();e.setvoice();e.getItems()},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=b.items.length;c.correctitems=b.items.filter(function(a){return a.correct}).length;c.answers=b.items.reduce(function(a,b,c){if(!a[c]){a[c]={}}a[c].correct=!!b.correct;return a},b.answers);c.grade=Math.round(100*(c.correctitems/c.totalitems));b.quizhelper.do_next(c,a)},register_events:function register_events(){var b=this;a("#"+b.itemdata.uniqueid+"_container .minispeak_nextbutton").on("click",function(){b.next_question()});a("#"+b.itemdata.uniqueid+"_container .sgapfill_start_btn").on("click",function(){b.start()});var c=a("#"+b.itemdata.uniqueid+"_container .sgapfill_listen_btn");if(b.itemdata.readsentence){c.on("click",function(){var d=b.items[b.game.pointer].audio;if(!d.paused){d.pause();d.currentTime=0;a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up");return}d.addEventListener("ended",function(){a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up")});d.addEventListener("play",function(){a(c).children(".fa").removeClass("fa-volume-up");a(c).children(".fa").addClass("fa-stop")});d.load();d.play()})}a("#"+b.itemdata.uniqueid+"_container .sgapfill_skip_btn").on("click",function(){a("#"+b.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0);a("#"+b.itemdata.uniqueid+"_container .sgapfill_speech.sgapfill_teacher_left").text(b.items[b.game.pointer].prompt+"");a("#"+b.itemdata.uniqueid+"_container .sgapfill_targetWord").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].sgapfill_targetWords[c];a(this).val(d)});b.stopTimer(b.items[b.game.pointer].timer);if(b.game.pointer<b.items.length-1){setTimeout(function(){a(".sgapfill_reply_"+b.game.pointer).hide();b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;b.game.pointer++;b.nextPrompt()},2e3)}else{b.end()}})},game:{pointer:0},usevoice:"",setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{target:a.sentence,prompt:a.prompt,parsedstring:a.parsedstring,displayprompt:a.displayprompt,definition:a.definition,phonetic:a.phonetic,words:a.words,typed:"",timer:[],answered:!1,correct:!1,audio:null}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,c){e.fetch_polly_url(c.prompt,b.voiceoption,b.usevoice).then(function(a){c.audio=new Audio;c.audio.src=a;if(0===b.items.filter(function(a){return null===a.audio}).length){b.appReady()}})})},appReady:function appReady(){var b=this;a("#"+b.itemdata.uniqueid+"_container .sgapfill_not_loaded").hide();a("#"+b.itemdata.uniqueid+"_container .sgapfill_loaded").show();a("#"+b.itemdata.uniqueid+"_container .sgapfill_start_btn").prop("disabled",!1)},gotComparison:function gotComparison(c,d){b.debug("sgapfill comparison");var e=this,f=a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer+" .dictate_feedback[data-idx='"+e.game.pointer+"']");a("#"+e.itemdata.uniqueid+"_container .sgapfill_targetWord").removeClass("sgapfill_correct sgapfill_incorrect");a("#"+e.itemdata.uniqueid+"_container .sgapfill_feedback").removeClass("fa fa-check fa-times");var g=0==c.filter(function(a){return!a.matched}).length;b.debug("aallcorrect="+g);if(g&&c&&0<c.length){e.items[e.game.pointer].parsedstring.forEach(function(b,c){var d=a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer+" input.single-character[data-index=\""+c+"\"]");if("input"===b.type){d.val(b.character)}});f.removeClass("fa fa-times");f.addClass("fa fa-check");b.debug("applying correct class to input boxes");a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer+" input").addClass("ms_gapfill_char_correct");e.items[e.game.pointer].answered=!0;e.items[e.game.pointer].correct=!0;e.items[e.game.pointer].typed=d;a("#"+e.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0);e.stopTimer(e.items[e.game.pointer].timer);if(e.game.pointer<e.items.length-1){setTimeout(function(){a(".sgapfill_reply_"+e.game.pointer).hide();e.game.pointer++;e.nextPrompt()},2e3)}else{e.end()}}else{f.removeClass("fa fa-check");f.addClass("fa fa-times");c.forEach(function(b){var c=e.items[e.game.pointer].words;Object.keys(c).forEach(function(d){if(c[d]==b.word){if(!b.matched){e.items[e.game.pointer].parsedstring.forEach(function(b,c){var f=a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer+" input.single-character[data-index=\""+c+"\"]");if(b.index==d&&"input"===b.type){f.val("")}})}else{e.items[e.game.pointer].parsedstring.forEach(function(b,c){var f=a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer+" input.single-character[data-index=\""+c+"\"]");if(b.index==d&&"input"===b.type){f.val(b.character)}})}}})});var i=a("#"+e.itemdata.uniqueid+"_container .sgapfill_reply_"+e.game.pointer);h.do_animate(i,"shakeX animate__faster").then(function(){a("#"+e.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!1)})}a("#"+e.itemdata.uniqueid+"_container .sgapfill_targetWord.sgapfill_correct").each(function(){var b=a(this).data("realidx"),c=e.items[e.game.pointer].sgapfill_targetWords[b];a(this).val(c)});var j=a("#"+e.itemdata.uniqueid+"_container .progress-container .progress-bar");if(!e.itemdata.allowretry||j.hasClass("progress-bar-complete")){e.items[e.game.pointer].answered=!0;e.items[e.game.pointer].correct=!1;e.items[e.game.pointer].typed=d;a("#"+e.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0);e.stopTimer(e.items[e.game.pointer].timer);if(e.game.pointer<e.items.length-1){setTimeout(function(){a(".sgapfill_reply_"+e.game.pointer).hide();e.game.pointer++;e.nextPrompt()},2e3)}else{e.end()}}},getComparison:function getComparison(b,c,d,e){var f=this;if(!f.answers[f.game.pointer]){f.answers[f.game.pointer]={}}f.answers[f.game.pointer].answer=c;a(".sgapfill_ctrl-btn").prop("disabled",!0);f.quizhelper.comparePassageToTranscript(b,c,d,f.itemdata.language).then(function(a){var b=JSON.parse(a);if(b){e(b)}else{e(!1)}})},end:function end(){var b=this;a(".minispeak_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minispeak_nextbutton").prop("disabled",!1);b.next_question(!0)},2e3)},start:function start(){var b=this;a("#"+b.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0);a("#"+b.itemdata.uniqueid+"_container .sgapfill_speakbtncontainer").show();b.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});b.answers={};b.game.pointer=0;a("#"+b.itemdata.uniqueid+"_container .question").show();if(b.itemdata.readsentence){a("#"+b.itemdata.uniqueid+"_container .sgapfill_listen_cont").show()}a("#"+b.itemdata.uniqueid+"_container .sgapfill_start_btn").hide();a("#"+b.itemdata.uniqueid+"_container .sgapfill_mainmenu").hide();a("#"+b.itemdata.uniqueid+"_container .sgapfill_controls").show();b.nextPrompt()},nextPrompt:function nextPrompt(){var b=this;a(".sgapfill_ctrl-btn").prop("disabled",!1);var c,d=b.items.map(function(a,d){c="gray";if(b.items[d].answered&&b.items[d].correct){c="green"}else if(b.items[d].answered&&!b.items[d].correct){c="red"}return"<i style='color:"+c+"' class='fa fa-circle'></i>"}).join(" ");a("#"+b.itemdata.uniqueid+"_container .sgapfill_title").html(d);var e=a(".sgapfill_prompt_"+b.game.pointer);h.do_animate(e,"zoomIn animate__faster","in").then(function(){});b.nextReply()},nextReply:function nextReply(){var b=this,c="<div class='sgapfill_reply sgapfill_reply_"+b.game.pointer+" text-center' style='display:none;'>";c+="<div class='form-container'>";b.items[b.game.pointer].parsedstring.forEach(function(a,b){if("input"===a.type){c+="<input class='single-character' autocomplete='off' type='text' name='filltext"+b+"' maxlength='1' data-index='"+b+"' readonly>"}else if("mtext"===a.type){c+="<input class='single-character-mtext' type='text' name='readonly"+b+"' maxlength='1' value='"+a.character+"' readonly>"}else{c+=a.character}});c+=" <i data-idx='"+b.game.pointer+"' class='dictate_feedback'></i></div>";c+="<div class='definition-container'>";c+="<div class='definition'>"+b.items[b.game.pointer].definition+"</div>";c+="</div>";a("#"+b.itemdata.uniqueid+"_container .question").append(c);var d=a(".sgapfill_reply_"+b.game.pointer);h.do_animate(d,"zoomIn animate__faster","in").then(function(){});a("#"+b.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!1);if(0<b.itemdata.timelimit){a("#"+b.itemdata.uniqueid+"_container .progress-container").show();a("#"+b.itemdata.uniqueid+"_container .progress-container i").show();var e=a("#"+b.itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){a("#"+b.itemdata.uniqueid+"_container .sgapfill_skip_btn").trigger("click")}});e.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})}if(!b.quizhelper.mobile_user()){setTimeout(function(){a("#"+b.itemdata.uniqueid+"_container .sgapfill_listen_btn").trigger("click")},1e3)}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}}}});
//# sourceMappingURL=speakinggapfill.min.js.map
