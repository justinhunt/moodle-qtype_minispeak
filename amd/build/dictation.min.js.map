{"version":3,"file":"dictation.min.js","sources":["../src/dictation.js"],"sourcesContent":["define(['jquery', 'core/log', 'qtype_minispeak/definitions', 'qtype_minispeak/pollyhelper'], function($, log, def, polly) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('minispeak dictation: initialising');\n\n  return {\n\n    answers: {},\n\n    playing: false,\n\n      //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n      },\n\n\n      init: function(index, itemdata, quizhelper, polly) {\n\n      this.prepare_audio(itemdata, polly);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    prepare_html: function(itemdata) {\n      //do something\n    },\n\n    prepare_audio: function(itemdata) {\n      $.each(itemdata.sentences, function(index, sentence) {\n        polly.fetch_polly_url(sentence.prompt, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n          $(\"#\" + itemdata.uniqueid + \"_container .dictationplayer_\" + index + \" .dictationtrigger\").attr(\"data-src\", audiourl);\n        });\n      });\n    },\n\n    register_events: function(qindex, itemdata, quizhelper) {\n\n      var self = this;\n\n      var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n\n      var lastgrade = null;\n      var totalanswer = $('#' + itemdata.uniqueid + '_container .dictate-feedback').length;\n\n      function updateGrade() {\n        var stepdata = {};\n        var correctanswer = $('#' + itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n        var grade = Math.round(100 * correctanswer / totalanswer, 2);\n        if (grade === lastgrade) {\n          return;\n        }\n        lastgrade = grade;\n        stepdata.index = qindex;\n        stepdata.hasgrade = true;\n        stepdata.grade = grade;\n        stepdata.totalitems=totalanswer;\n        stepdata.correctitems=correctanswer;\n        stepdata.answers = self.answers;\n        quizhelper.do_next(stepdata);\n      }\n\n      //key events in text box\n      $(\"#\" + itemdata.uniqueid + \"_container .poodlldictationinput input\").on(\"input\", function(e) {\n\n        var index = $(this).data(\"index\");\n        var correct = itemdata.sentences[index].sentence.trim().toLowerCase();\n        var typed = $(this).val().trim().toLowerCase();\n\n        //update char count\n        $(\"#\"+itemdata.uniqueid+\"_container .dictationplayer_\"+index+\"_chars\").html(typed.length);\n        //trim punctuation before comparing, if ignore punctuation is set\n        if(itemdata.ignorepunctuation){\n            correct = quizhelper.cleanText(correct);\n            typed = quizhelper.cleanText(typed);\n        }\n        self.answers[index] = {\n          answer: typed,\n          correct: correct == typed\n        };\n\n        if (correct == typed) {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-times\").addClass(\"fa-check\").css(\"color\",\"green\").show();\n        } else {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-check\").addClass(\"fa-times\").css(\"color\",\"red\").show();\n        }\n        updateGrade();\n      });\n\n      //audio play requests\n      $(\"#\" + itemdata.uniqueid + \"_container .dictationtrigger\").on('click', function(e) {\n        if (!self.playing) {\n          var el = this;\n          self.playing = true;\n          theplayer.attr('src', $(this).attr('data-src'));\n          theplayer[0].play();\n          theplayer[0].onended = function() {\n            $(el).find(\".fa\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n            self.playing = false;\n          }\n          $(el).find(\".fa\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n        }\n      });\n\n      //When click next button , report and leave it up to parent to eal with it.\n      $(\"#\" + itemdata.uniqueid + \"_container .minispeak_nextbutton\").on('click', updateGrade);\n    }\n  }; //end of return value\n});"],"names":["define","$","log","def","polly","debug","answers","playing","clone","extend","this","init","index","itemdata","quizhelper","prepare_audio","register_events","prepare_html","each","sentences","sentence","fetch_polly_url","prompt","voiceoption","usevoice","then","audiourl","uniqueid","attr","qindex","self","theplayer","lastgrade","totalanswer","length","updateGrade","stepdata","correctanswer","grade","Math","round","hasgrade","totalitems","correctitems","do_next","on","e","data","correct","trim","toLowerCase","typed","val","html","ignorepunctuation","cleanText","answer","removeClass","addClass","css","show","el","play","onended","find"],"mappings":"AAAAA,mCAAO,CAAC,SAAU,WAAY,8BAA+B,gCAAgC,SAASC,EAAGC,IAAKC,IAAKC,cAOjHF,IAAIG,MAAM,qCAEH,CAELC,QAAS,GAETC,SAAS,EAGPC,MAAO,kBACIP,EAAEQ,QAAO,EAAM,GAAIC,OAI9BC,KAAM,SAASC,MAAOC,SAAUC,WAAYV,YAEvCW,cAAcF,SAAUT,YACxBY,gBAAgBJ,MAAOC,SAAUC,aAIxCG,aAAc,SAASJ,YAIvBE,cAAe,SAASF,UACtBZ,EAAEiB,KAAKL,SAASM,WAAW,SAASP,MAAOQ,UACzChB,MAAMiB,gBAAgBD,SAASE,OAAQT,SAASU,YAAaV,SAASW,UAAUC,MAAK,SAASC,UAC5FzB,EAAE,IAAMY,SAASc,SAAW,+BAAiCf,MAAQ,sBAAsBgB,KAAK,WAAYF,iBAKlHV,gBAAiB,SAASa,OAAQhB,SAAUC,gBAEtCgB,KAAOpB,KAEPqB,UAAY9B,EAAE,IAAMY,SAASc,SAAW,WAExCK,UAAY,KACZC,YAAchC,EAAE,IAAMY,SAASc,SAAW,gCAAgCO,gBAErEC,kBACHC,SAAW,GACXC,cAAgBpC,EAAE,IAAMY,SAASc,SAAW,yCAAyCO,OACrFI,MAAQC,KAAKC,MAAM,IAAMH,cAAgBJ,YAAa,GACtDK,QAAUN,YAGdA,UAAYM,MACZF,SAASxB,MAAQiB,OACjBO,SAASK,UAAW,EACpBL,SAASE,MAAQA,MACjBF,SAASM,WAAWT,YACpBG,SAASO,aAAaN,cACtBD,SAAS9B,QAAUwB,KAAKxB,QACxBQ,WAAW8B,QAAQR,WAIrBnC,EAAE,IAAMY,SAASc,SAAW,0CAA0CkB,GAAG,SAAS,SAASC,OAErFlC,MAAQX,EAAES,MAAMqC,KAAK,SACrBC,QAAUnC,SAASM,UAAUP,OAAOQ,SAAS6B,OAAOC,cACpDC,MAAQlD,EAAES,MAAM0C,MAAMH,OAAOC,cAGjCjD,EAAE,IAAIY,SAASc,SAAS,+BAA+Bf,MAAM,UAAUyC,KAAKF,MAAMjB,QAE/ErB,SAASyC,oBACRN,QAAUlC,WAAWyC,UAAUP,SAC/BG,MAAQrC,WAAWyC,UAAUJ,QAEjCrB,KAAKxB,QAAQM,OAAS,CACpB4C,OAAQL,MACRH,QAASA,SAAWG,OAGlBH,SAAWG,MACblD,EAAE,IAAIY,SAASc,SAAS,4CAA8Cf,MAAQ,MAAM6C,YAAY,YAAYC,SAAS,YAAYC,IAAI,QAAQ,SAASC,OAEtJ3D,EAAE,IAAIY,SAASc,SAAS,4CAA8Cf,MAAQ,MAAM6C,YAAY,YAAYC,SAAS,YAAYC,IAAI,QAAQ,OAAOC,OAEtJzB,iBAIFlC,EAAE,IAAMY,SAASc,SAAW,gCAAgCkB,GAAG,SAAS,SAASC,OAC1EhB,KAAKvB,QAAS,KACbsD,GAAKnD,KACToB,KAAKvB,SAAU,EACfwB,UAAUH,KAAK,MAAO3B,EAAES,MAAMkB,KAAK,aACnCG,UAAU,GAAG+B,OACb/B,UAAU,GAAGgC,QAAU,WACrB9D,EAAE4D,IAAIG,KAAK,OAAOP,YAAY,sBAAsBC,SAAS,WAC7D5B,KAAKvB,SAAU,GAEjBN,EAAE4D,IAAIG,KAAK,OAAOP,YAAY,WAAWC,SAAS,0BAKtDzD,EAAE,IAAMY,SAASc,SAAW,oCAAoCkB,GAAG,QAASV"}