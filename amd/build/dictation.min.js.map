{"version":3,"sources":["../src/dictation.js"],"names":["define","$","log","def","polly","debug","answers","playing","clone","extend","init","index","itemdata","quizhelper","prepare_audio","register_events","prepare_html","each","sentences","sentence","fetch_polly_url","prompt","voiceoption","usevoice","then","audiourl","uniqueid","attr","qindex","self","theplayer","lastgrade","totalanswer","length","updateGrade","stepdata","correctanswer","grade","Math","round","hasgrade","totalitems","correctitems","do_next","on","data","correct","trim","toLowerCase","typed","val","html","ignorepunctuation","cleanText","answer","removeClass","addClass","css","show","el","play","onended","find"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'qtype_minispeak/definitions', 'qtype_minispeak/pollyhelper'], function($, log, def, polly) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('minispeak dictation: initialising');\n\n  return {\n\n    answers: {},\n\n    playing: false,\n\n      //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n      },\n\n\n      init: function(index, itemdata, quizhelper, polly) {\n\n      this.prepare_audio(itemdata, polly);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    prepare_html: function(itemdata) {\n      //do something\n    },\n\n    prepare_audio: function(itemdata) {\n      $.each(itemdata.sentences, function(index, sentence) {\n        polly.fetch_polly_url(sentence.prompt, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n          $(\"#\" + itemdata.uniqueid + \"_container .dictationplayer_\" + index + \" .dictationtrigger\").attr(\"data-src\", audiourl);\n        });\n      });\n    },\n\n    register_events: function(qindex, itemdata, quizhelper) {\n\n      var self = this;\n\n      var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n\n      var lastgrade = null;\n      var totalanswer = $('#' + itemdata.uniqueid + '_container .dictate-feedback').length;\n\n      function updateGrade() {\n        var stepdata = {};\n        var correctanswer = $('#' + itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n        var grade = Math.round(100 * correctanswer / totalanswer, 2);\n        if (grade === lastgrade) {\n          return;\n        }\n        lastgrade = grade;\n        stepdata.index = qindex;\n        stepdata.hasgrade = true;\n        stepdata.grade = grade;\n        stepdata.totalitems=totalanswer;\n        stepdata.correctitems=correctanswer;\n        stepdata.answers = self.answers;\n        quizhelper.do_next(stepdata);\n      }\n\n      //key events in text box\n      $(\"#\" + itemdata.uniqueid + \"_container .poodlldictationinput input\").on(\"input\", function(e) {\n\n        var index = $(this).data(\"index\");\n        var correct = itemdata.sentences[index].sentence.trim().toLowerCase();\n        var typed = $(this).val().trim().toLowerCase();\n\n        //update char count\n        $(\"#\"+itemdata.uniqueid+\"_container .dictationplayer_\"+index+\"_chars\").html(typed.length);\n        //trim punctuation before comparing, if ignore punctuation is set\n        if(itemdata.ignorepunctuation){\n            correct = quizhelper.cleanText(correct);\n            typed = quizhelper.cleanText(typed);\n        }\n        self.answers[index] = {\n          answer: typed,\n          correct: correct == typed\n        };\n\n        if (correct == typed) {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-times\").addClass(\"fa-check\").css(\"color\",\"green\").show();\n        } else {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-check\").addClass(\"fa-times\").css(\"color\",\"red\").show();\n        }\n        updateGrade();\n      });\n\n      //audio play requests\n      $(\"#\" + itemdata.uniqueid + \"_container .dictationtrigger\").on('click', function(e) {\n        if (!self.playing) {\n          var el = this;\n          self.playing = true;\n          theplayer.attr('src', $(this).attr('data-src'));\n          theplayer[0].play();\n          theplayer[0].onended = function() {\n            $(el).find(\".fa\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n            self.playing = false;\n          }\n          $(el).find(\".fa\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n        }\n      });\n\n      //When click next button , report and leave it up to parent to eal with it.\n      $(\"#\" + itemdata.uniqueid + \"_container .minispeak_nextbutton\").on('click', updateGrade);\n    }\n  }; //end of return value\n});"],"file":"dictation.min.js"}